<!DOCTYPE html>
<head>
  <script src="./switch.js" type="module"></script>
</head>
<body>
  <div class="top-bar">
    <form>
      <fieldset class="container">
        <legend>
          <light-switch data-switch-name="animMode">
            <light-switch-state data-switch-state="singleLine">Singe line</light-switch-state>
            <light-switch-state data-switch-state="full" data-active>Full</light-switch-state>
          </light-switch>
        </legend>
        <label for="input">Initial input</label>
        <input type="text" id="input" value="0010001001" pattern="[01]+" required />
        <fieldset>
          <legend>
            <small>Generate random of length</small>
          </legend>
          <input type="number" value="500" id="randomizer-input" placeholder="Input length e.g. 50" required/>
          <button type="button" id="randomize-input-btn" title="Randomize input">ðŸŽ²</button>
        </fieldset>
        <div class="container" data-light-switch-show-if="animMode.singleLine">
          <label for="speed">Speed</label>
          <input type="range" id="speed" min="0" max="1000" value="500" />
        </div>
        <div class="container" data-light-switch-show-if="animMode.full">
          <label for="resize-canvas-width">Resize canvas</label>
          <input type="number" size="3" placeholder="Width of the canvas" id="resize-canvas-width" value="800"/>
          x
          <input type="number" size="3" placeholder="Height of the canvas" id="resize-canvas-height" value="800"/>
        </div>
        <button type="submit" id="ca-full-btn" data-light-switch-show-if="animMode.full" class="end-btn">
          Full
        </button>
        <button type="submit" id="ca-animate-single-line-btn" data-light-switch-show-if="animMode.singleLine" class="end-btn">
          Animate Single line
        </button>
      </fieldset>
    </form>
  </div>
<canvas id="main" width=800 height=800>
</canvas>

<style>
  .light-switch-element-hidden {
    display: none !important;
  }
  input:invalid {
    border: 1px solid red;
  }
  .end-btn {
    margin-left: auto;
  }
  .container {
    display: flex;
    align-items:center;
  }
</style>

<script src="evalf.js"></script>
<script>
    const showFullBtn = document.getElementById("ca-full-btn");
    let clearPrevious = () => {};
    showFullBtn.addEventListener('click', (e) => {
      e.preventDefault();
      clearPrevious();
      const widthElem = document.getElementById('resize-canvas-width');
      const heightElem = document.getElementById('resize-canvas-height');
      const width = widthElem.valueAsNumber;
      const height = heightElem.valueAsNumber;
      canvas.width = width;
      canvas.height = height;
      setTimeout(() => {
        const input = document.getElementById("input").value;
        clearPrevious = drawTriangleIterations(input, input.length-1);
        setTimeout(() => {
          widthElem.valueAsNumber = canvas.width;
          heightElem.valueAsNumber = canvas.height;
        }, 100);
      })
    });
    const speedElem = document.getElementById('speed');
    const animateSingleLineBtn = document.getElementById("ca-animate-single-line-btn");
    animateSingleLineBtn.addEventListener('click', (e) => {
        e.preventDefault();
      clearPrevious();
      setTimeout(() => {
        input = document.getElementById("input").value;
        shouldStop = false;
        clearPrevious = drawOneInput(input, input.length-1)
        window.requestAnimationFrame(iterationStep)
      });
    });

const randomizerButton = document.getElementById("randomize-input-btn");
    randomizerButton.addEventListener('click', e => {
      e.preventDefault();
      const inputLen = document.getElementById('randomizer-input').valueAsNumber;
const s = generateBinaryString(inputLen);
      document.getElementById('input').value = s;
    });

    const canvas = document.getElementById("main");
    const ctx = canvas.getContext("2d");

    function drawTriangleIterations(init_input,n) {
        let input = init_input;
        //draw grid
        const width = canvas.width;
        const height = canvas.height;
        const len = input.length;
        let cellwidth = width/len;
        let cellheight = height/n;
        
      console.log(width, height);
        ctx.clearRect(0, 0, width, height);

        if(cellwidth < 1) {
        	canvas.width = len;
        	cellwidth = 1;
        }
        if(cellheight < 1) {
        	canvas.height = n;
        	cellheight = 1;
        }

      ctx.beginPath();
        for(let i=0;i<=len;i++) {
            ctx.moveTo(cellwidth*i, 0);
            ctx.lineTo(cellwidth*i, height);
        }
        for(let i=0;i<=n;i++) {
            ctx.moveTo(0, cellheight*i);
            ctx.lineTo(width, cellheight*i);
        }
        ctx.stroke();

        //fill the grid
        for(let i=0;i<=n;i++) {
            for(let j=0;j<len;j++)
                if(input[j]=="1")
                    ctx.fillRect(j*cellwidth, i*cellheight, cellwidth, cellheight);
            input = evalinput(input);
        }
      return () => ctx.clearRect(0,0, width, height);
    }
    
    function drawOneInput(init_input, n) {
    	var input = init_input;
    	
    	var width = canvas.width;
    	var height = canvas.height;
    	var len = input.length;
    	var cellwidth = width/len;
    	var cellheight = cellwidth;
    	var showgrid = true;
    	
    	ctx.clearRect(0,0,width, cellheight);
    	
    	if(cellwidth <= 1) {
    		canvas.width = len;
    		cellwidth = 1;
    		showgrid = false;
    	}
    	
    	if(showgrid) {
        ctx.beginPath();
    		for(var i=0;i<=len;i++) {
    			ctx.moveTo(cellwidth*i, 0);
    			ctx.lineTo(cellwidth*i, cellheight);
    		}
    		ctx.moveTo(0,0);
    		ctx.lineTo(width,0);
    		ctx.moveTo(0,cellheight);
    		ctx.lineTo(width, cellheight);
    		ctx.stroke();
    	}
    	
    	ctx.fillStyle = '#000';
    	for(var j=0;j<len;j++) {
    		if(input[j]=="1")
    			ctx.fillRect(j*cellwidth, 0, cellwidth, cellheight);
    	}
      return () => {
        shouldStop = true;
        ctx.clearRect(0,0, width, height);
      }
    }
    
    var input ="0".repeat(500)+"10";
    //var input = "0010001001";

    let shouldStop = false;
    let start=0;
    function iterationStep(timestamp) {
   const speed = speedElem.valueAsNumber ;
    	const time_interval = 1000 - speed;
    	const elapsed = timestamp - start;
    	
    	if(elapsed > time_interval) {
    		start = timestamp;
    		input = evalinput(input);
    		//console.log(input);
    		drawOneInput(input, input.length-1)
    	}
    	
      if (!shouldStop) {
    	  window.requestAnimationFrame(iterationStep);
      }
    }


    //drawOneInput(input, input.length-1);
    //window.requestAnimationFrame(iterationStep);

function generateBinaryString(n) {
  if (n <= 0) {
    return "";
  }
  let result = "";
  for (let i = 0; i < n; i++) {
    result += Math.round(Math.random());
  }
  return result;
}

</script>
</body>
